stages:
  - deploy

deploy:
  stage: deploy
  tags:
    - Deploy  # ‚Üê –î–û–ë–ê–í–õ–ï–ù–û!
  script:
    # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ SSH-–∫–ª–∏–µ–Ω—Ç–∞ (–µ—Å–ª–∏ –µ—â—ë –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)
    - 'which ssh-agent || ( apt-get update -qq && apt-get install -y openssh-client git )'
    
    # –ó–∞–ø—É—Å–∫ –∞–≥–µ–Ω—Ç–∞
    - eval $(ssh-agent -s)
    
    # –°–æ–∑–¥–∞–Ω–∏—è .ssh directory
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    
    # –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π GitLab
    - echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_ed25519
    - chmod 600 ~/.ssh/id_ed25519
    
    # –î–æ–±–∞–≤–ª—è–µ–º —Ö–æ—Å—Ç –≤ known_hosts
    - ssh-keyscan -H $SERVER_HOST >> ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
    
    # –í—ã–ø–æ–ª–Ω—è–µ–º –∫–æ–º–∞–Ω–¥—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
    - ssh -v -o StrictHostKeyChecking=yes admin@$SERVER_HOST "
        cd /opt/supabase-admin-panel &&
        echo 'üîÅ –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è...' &&
        git pull origin main &&
        echo 'üõ†Ô∏è –ü–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º –æ–±—Ä–∞–∑—ã...' &&
        docker compose build --no-cache &&
        echo 'üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã...' &&
        docker compose down &&
        echo 'üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å—ã...' &&
        docker compose up -d
      "
  rules:
    - if: $CI_COMMIT_BRANCH == "main"  # ‚Üê –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å –≤–º–µ—Å—Ç–æ only: